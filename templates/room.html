{% extends "base.html" %}

{% block title %}
Room â€“ {{ room_name }}
{% endblock %}

{% block content %}
<div class="chat-container">

  <!-- HEADER -->
  <div class="chat-header">
    <h2>ðŸ’¬ðŸ“¹ {{ room_name }}</h2>
    <p>You are {{ username }}</p>
  </div>

  <!-- VIDEO -->
  <div class="video-container">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div class="call-controls">
    <button id="startCall">Start Call</button>
    <button id="endCall">End Call</button>
  </div>

  <!-- CHAT -->
  <div id="chat" class="chat-messages"></div>

  <div class="chat-input-container">
    <input id="chat-message-input" type="text" placeholder="Type message..." />
    <button id="chat-message-submit">Send</button>
  </div>

</div>
{% endblock %}

{% block include_js %}
{{ room_name|json_script:"room_name" }}
{{ username|json_script:"username" }}
{% endblock %}

{% block domready %}

/* =======================
   COMMON
======================= */
const room_name = JSON.parse(document.getElementById("room_name").textContent);
const username = JSON.parse(document.getElementById("username").textContent);
const protocol = window.location.protocol === "https:" ? "wss" : "ws";

/* =======================
   CHAT SOCKET
======================= */
const chatSocket = new WebSocket(
  `${protocol}://${window.location.host}/ws/room/${room_name}/${username}/`
);

chatSocket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  const chat = document.getElementById("chat");

  const isMe = data.user === username;
  const source = isMe ? "me" : "other";

  const messageDiv = document.createElement("div");
  messageDiv.className = `message ${source} message-new`;

  const time = new Date().toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });

  messageDiv.innerHTML = `
    <strong>${isMe ? "Me" : data.user}</strong>
    <span class="date">${time}</span>
    ${data.message}
  `;

  chat.appendChild(messageDiv);
  chat.scrollTop = chat.scrollHeight;

  setTimeout(() => {
    messageDiv.classList.remove("message-new");
  }, 300);
};


document.getElementById("chat-message-submit").onclick = () => {
  const input = document.getElementById("chat-message-input");
  if (input.value.trim()) {
    chatSocket.send(JSON.stringify({ message: input.value }));
    input.value = "";
  }
};

/* =======================
   CALL SOCKET
======================= */
const callSocket = new WebSocket(
  `${protocol}://${window.location.host}/ws/call/${room_name}/${username}/`
);

let localStream;
let peerConnection;

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");

const iceServers = {
  iceServers: [
    { urls: "stun:global.stun.twilio.com:3478" },
    {
      urls: "turn:global.turn.twilio.com:3478?transport=udp",
      username: "020523fde1e5687baca0a889e59fdacbeb8c72a41275d18f29ceede20e83eb54",
      credential: "1acs3lV7hOIMiXSJxdHwapuf680s0hsNKjwcQrdvNEY="
    },
    {
      urls: "turn:global.turn.twilio.com:3478?transport=tcp",
      username: "020523fde1e5687baca0a889e59fdacbeb8c72a41275d18f29ceede20e83eb54",
      credential: "1acs3lV7hOIMiXSJxdHwapuf680s0hsNKjwcQrdvNEY="
    },
    {
      urls: "turn:global.turn.twilio.com:443?transport=tcp",
      username: "020523fde1e5687baca0a889e59fdacbeb8c72a41275d18f29ceede20e83eb54",
      credential: "1acs3lV7hOIMiXSJxdHwapuf680s0hsNKjwcQrdvNEY="
    }
  ]
};


navigator.mediaDevices.getUserMedia({ video: true, audio: true })
.then(stream => {
  localStream = stream;
  localVideo.srcObject = stream;
});

callSocket.onmessage = async (e) => {
  const data = JSON.parse(e.data);
  if (data.user === username) return;

  if (data.type === "offer") await createAnswer(data.data);
  if (data.type === "answer") await peerConnection.setRemoteDescription(data.data);
  if (data.type === "ice-candidate") await peerConnection.addIceCandidate(data.data);
};

async function createPeerConnection() {
  peerConnection = new RTCPeerConnection(iceServers);

  localStream.getTracks().forEach(track =>
    peerConnection.addTrack(track, localStream)
  );

  peerConnection.ontrack = e => {
    remoteVideo.srcObject = e.streams[0];
  };

  peerConnection.onicecandidate = e => {
    if (e.candidate) {
      callSocket.send(JSON.stringify({
        type: "ice-candidate",
        data: e.candidate
      }));
    }
  };
}

async function startCall() {
  await createPeerConnection();
  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);

  callSocket.send(JSON.stringify({
    type: "offer",
    data: offer
  }));
}

async function createAnswer(offer) {
  await createPeerConnection();
  await peerConnection.setRemoteDescription(offer);

  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);

  callSocket.send(JSON.stringify({
    type: "answer",
    data: answer
  }));
}

document.getElementById("startCall").onclick = startCall;
document.getElementById("endCall").onclick = () => peerConnection?.close();

{% endblock %}
